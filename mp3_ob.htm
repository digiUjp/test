<head>
    <meta charset="UTF-8">
</head>

<body style="font-size: 22px">
    <script src="mp3_ob.js"></script>
    <script>
        let o = console.log
        let count = 0
        function getDataString() {
            let ret = []
            for (k in mp3_ob) {
                if (mp3_ob[k]) {
                    ret.push(`<span class="word" id="${k}">${k}</span>`)
                    // o([k, mp3_ob[k]])
                } else {
                    ret.push(`<span style="color: gray">${k}</span>`)
                }
                // ret[k]= mp3_ob[k]
                // o(k)
                count++
                // if (count > 800) break
            }
            return ret.join(" ")
        }
        function playMp3(word, fn_then, fn_catch) {
            if( ! mp3_ob[word]){
                //o("no word audio: " + word)
                fn_catch(word, "(no word)")
                return
            }
            new Audio(mp3_ob[word]).play().then(() =>{
                 //o('play, ' + url)
                 fn_then(word)
            }).catch(e =>{
                 //o('Playback failed:', [word, mp3_ob[word]])                 
                 fn_catch(word, e)
            })
        }
        onload = () => {
            document.querySelector('body').innerHTML = getDataString()
            document.querySelectorAll('.word').forEach(dom => {
                dom.addEventListener('click', event => {
                    //o(dom.innerHTML) //need to be .innerHTML, not innerTEXT
                    //Array.from(document.querySelectorAll(".word")).find(a => a.innerHTML.includes("a"))
                    playMp3(dom.innerHTML)
                })
            })
            const intervalMs = 12000
            function scrollPage() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight || document.documentElement.clientHeight;
                const docHeight = Math.max(
                    document.body.scrollHeight, document.documentElement.scrollHeight,
                    document.body.offsetHeight, document.documentElement.offsetHeight,
                    document.body.clientHeight, document.documentElement.clientHeight
                )
                if (scrollTop + windowHeight + 5 >= docHeight) {
                    window.scrollTo({ top: 0 })//, behavior: 'smooth'
                } else {
                    window.scrollBy({ top: windowHeight, left: 0 })
                }
            }
            //setInterval(scrollPage, intervalMs)
            function test_play(){
                let key_ar= []
                for(let k in mp3_ob) key_ar.push(k)
                let index=0
                function playNext(){
                    playMp3(key_ar[index], function(word){
                        document.querySelector(`#${word}`).style.backgroundColor = "green"
                        o(index)
                        o(word + ", ok")
                        index+=1
                        if(index>= key_ar.length) return
                        setTimeout(playNext, 100)
                    }, function(word, e){
                        if(mp3_ob[word]) document.querySelector(`#${word}`).style.backgroundColor = "purple"
                        o(index)
                        o(word)
                        index+=1
                        if(index>= key_ar.length) return
                        setTimeout(playNext, 100)
                    })
                }
                playNext()
            }
            test_play()
        }
    </script>
</body>
